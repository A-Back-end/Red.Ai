# ‚úÖ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å Clerk.js –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ä–µ–¥

## üéØ –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Ä–µ—à–µ–Ω—ã

### 1. –û—à–∏–±–∫–∏ —Å –¥–æ–º–µ–Ω–∞–º–∏
- ‚ùå `Failed to load resource: the server responded with a status of 400 ()` –¥–ª—è `clerk.redai.site/v1/...`
- ‚ùå `Error: Clerk: Production Keys are only allowed for domain "redai.site".`
- ‚ùå `API Error: The Request HTTP Origin header must be equal to or a subdomain of the requesting URL.`

### 2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ production –∫–ª—é—á–µ–π –¥–ª—è localhost
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ development –∫–ª—é—á–µ–π –¥–ª—è production –¥–æ–º–µ–Ω–∞
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ä–µ–¥—ã

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã
- **Development**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç test –∫–ª—é—á–∏ (`pk_test_*`) –¥–ª—è localhost
- **Production**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç live –∫–ª—é—á–∏ (`pk_live_*`) –¥–ª—è redai.site
- **Middleware**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ä–µ–¥—É –ø–æ –¥–æ–º–µ–Ω—É

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. –°–∫—Ä–∏–ø—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
- `scripts/setup-clerk-environments.sh` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ä–µ–¥
- `scripts/test-clerk-configuration.sh` - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `scripts/fix-clerk-production.sh` - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ production

### 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `.env.development` - –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- `.env.production` - –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- `.env.local` - –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- `.env` - –¥–ª—è Docker

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `middleware.ts` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—ã
- `app/layout.tsx` - –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π ClerkProvider

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `docs/CLERK_ENVIRONMENT_SETUP.md` - –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `CLERK_ENVIRONMENT_SOLUTION.md` - –¥–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç

## üîß –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. Middleware —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Å—Ä–µ–¥—ã
```typescript
export default clerkMiddleware(async (auth, req) => {
  const host = req.headers.get('host') || '';
  const isLocalhost = host.includes('localhost') || host.includes('127.0.0.1');
  const isProduction = host.includes('redai.site');
  
  // Development: –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞
  if (isLocalhost) {
    return NextResponse.next();
  }
  
  // Production: –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
  if (isProduction && isProtectedRoute(req)) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
  }
});
```

### 2. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ä–µ–¥—ã
```bash
# Development (localhost)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_bGVhcm5pbmctamVubmV0LTgzLmNsZXJrLmFjY291bnRzLmRldiQ

# Production (redai.site)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_Y2xlcmsucmVkYWkuc2l0ZSQ
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π ClerkProvider
```tsx
<ClerkProvider
  telemetry={false}
  allowedRedirectOrigins={[
    'http://localhost:3000',
    'http://localhost:3001',
    'http://127.0.0.1:3000',
    'http://127.0.0.1:3001',
    'https://redai.site',
    'https://www.redai.site'
  ]}
>
```

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
```bash
npm run dev
# ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç development –∫–ª—é—á–∏ (pk_test_*)
# ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞
# ‚úÖ –í—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –≤—Ö–æ–¥–∞
```

### –î–ª—è Docker —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
```bash
docker-compose up
# ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç development –∫–ª—é—á–∏ (pk_test_*)
# ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞
# ‚úÖ –í—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –≤—Ö–æ–¥–∞
```

### –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:
```bash
NODE_ENV=production npm run build && npm start
# ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç production –∫–ª—é—á–∏ (pk_live_*)
# ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
# ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å redai.site
```

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—ã

### Development (localhost):
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç development –∫–ª—é—á–∏ (`pk_test_*`)
- ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞
- ‚úÖ –í—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –≤—Ö–æ–¥–∞
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å localhost, 127.0.0.1

### Production (redai.site):
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç production –∫–ª—é—á–∏ (`pk_live_*`)
- ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
- ‚úÖ –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã —Ç—Ä–µ–±—É—é—Ç –≤—Ö–æ–¥–∞
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å redai.site

## üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π:
```bash
# Development
curl -s http://localhost:3000 | grep -o "pk_[a-zA-Z0-9_-]*" | head -1
# –†–µ–∑—É–ª—å—Ç–∞—Ç: pk_test_...

# Production
curl -s https://redai.site | grep -o "pk_[a-zA-Z0-9_-]*" | head -1
# –†–µ–∑—É–ª—å—Ç–∞—Ç: pk_live_...
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ middleware:
```bash
# –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:
# Development: "üîß Development mode: allowing all routes on localhost"
# Production: "üîí Production: redirecting to login for protected route"
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Development –∫–ª—é—á–∏** —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å localhost
2. **Production –∫–ª—é—á–∏** —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å redai.site
3. **Middleware** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ä–µ–¥—É –ø–æ –¥–æ–º–µ–Ω—É
4. **–í development —Ä–µ–∂–∏–º–µ** –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞
5. **–í production —Ä–µ–∂–∏–º–µ** –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤

## üõ†Ô∏è Troubleshooting

### –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ —Å –¥–æ–º–µ–Ω–∞–º–∏:
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ä–µ–¥—ã
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ middleware –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ä–µ–¥—É
3. –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### –ï—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ production:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–æ–º–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Clerk dashboard
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ production –∫–ª—é—á–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ï—Å–ª–∏ development –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ development –∫–ª—é—á–∏
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ localhost
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ middleware –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç localhost –ø—Ä–∞–≤–∏–ª—å–Ω–æ

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã!**

- ‚úÖ –û—à–∏–±–∫–∏ —Å –¥–æ–º–µ–Ω–∞–º–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ä–µ–¥—ã
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—ã
- ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Development –∏ production —Ä–µ–∂–∏–º—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ Docker –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

–¢–µ–ø–µ—Ä—å –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Clerk.js –≤ –æ–±–µ–∏—Ö —Å—Ä–µ–¥–∞—Ö –±–µ–∑ –æ—à–∏–±–æ–∫! 