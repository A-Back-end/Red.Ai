# Clerk Authentication Fixes Guide

## ‚úÖ –ü—Ä–æ–±–ª–µ–º—ã –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

### 1. **CAPTCHA Widget Error**
**–ü—Ä–æ–±–ª–µ–º–∞:** `Cannot initialize Smart CAPTCHA widget because the 'clerk-captcha' DOM element was not found`

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —ç–ª–µ–º–µ–Ω—Ç `<div id="clerk-captcha"></div>` –≤ —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
- `components/auth/AuthForm.tsx` - –¥–æ–±–∞–≤–ª–µ–Ω CAPTCHA —ç–ª–µ–º–µ–Ω—Ç
- `app/globals.css` - –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—Ç–∏–ª–∏ –¥–ª—è CAPTCHA

### 2. **Telemetry 400 Error**
**–ü—Ä–æ–±–ª–µ–º–∞:** `POST https://clerk-telemetry.com/v1/event 400 (Bad Request)`

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –û—Ç–∫–ª—é—á–µ–Ω–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è –≤ ClerkProvider

**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
- `app/layout.tsx` - –¥–æ–±–∞–≤–ª–µ–Ω `telemetry={false}`

### 3. **User Data Storage**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –£–ª—É—á—à–µ–Ω webhook –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
- `app/api/webhooks/clerk/route.ts` - –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `database/users.json` - —Å–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `app/api/users/route.ts` - API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

## üîß –ù–æ–≤—ã–µ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### API Endpoints –¥–ª—è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```bash
# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
GET /api/users

# –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Clerk ID
GET /api/users?clerkId=user_123

# –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
GET /api/users?email=test@example.com

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å webhook
POST /api/users
{
  "action": "test_webhook"
}

# –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
POST /api/users
{
  "action": "cleanup_test_users"
}
```

### Webhook Events –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

- ‚úÖ `user.created` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `user.updated` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
- ‚úÖ `user.deleted` - —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `session.created` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—Ö–æ–¥–∞
- ‚úÖ `session.ended` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –î–∞–Ω–Ω—ã—Ö –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```typescript
interface User {
  id: string;           // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –≤ –Ω–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ
  clerkId: string;      // ID –æ—Ç Clerk
  email: string;        // Email –∞–¥—Ä–µ—Å
  firstName?: string;   // –ò–º—è
  lastName?: string;    // –§–∞–º–∏–ª–∏—è
  profileImageUrl?: string; // URL –∞–≤–∞—Ç–∞—Ä–∞
  createdAt: Date;      // –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
  updatedAt: Date;      // –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  lastSignInAt?: Date;  // –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥
}
```

## üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –≤ Clerk Dashboard

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ [Clerk Dashboard](https://dashboard.clerk.com)
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ `Webhooks` ‚Üí `+ Add Endpoint`
4. URL: `https://your-domain.com/api/webhooks/clerk`
5. Events: –≤—ã–±–µ—Ä–∏—Ç–µ:
   - `user.created`
   - `user.updated` 
   - `user.deleted`
   - `session.created`
   - `session.ended`
6. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `Webhook Secret`
7. –î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:
   ```
   CLERK_WEBHOOK_SECRET=your_webhook_secret_here
   ```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É CAPTCHA:
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
2. CAPTCHA –¥–æ–ª–∂–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
curl http://localhost:3000/api/users

# –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
curl -X POST http://localhost:3000/api/users \
  -H "Content-Type: application/json" \
  -d '{"action": "test_webhook"}'
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook:
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `database/users.json` - –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏

## üîß –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –†–µ—à–µ–Ω–∏–µ (–û—Ç–∫–ª—é—á–µ–Ω–∏–µ CAPTCHA)

–ï—Å–ª–∏ CAPTCHA –Ω–µ –Ω—É–∂–Ω–∞, –º–æ–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∏—Ç—å:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ [Clerk Dashboard](https://dashboard.clerk.com)
2. `Configure` ‚Üí `Attack protection`
3. –û—Ç–∫–ª—é—á–∏—Ç–µ `Bot sign-up protection`

## üìù –õ–æ–≥–∏ –∏ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

Webhook –ª–æ–≥–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞:
- ‚úÖ `üë§ User created event received`
- ‚úÖ `üîÑ User updated event received`  
- ‚úÖ `üóëÔ∏è User deleted event received`
- ‚úÖ `üîê Session created event received`

## üõ†Ô∏è Troubleshooting

### CAPTCHA –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç `#clerk-captcha` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ DOM
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CSS —Å—Ç–∏–ª–∏ –≤ `app/globals.css`

### Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `CLERK_WEBHOOK_SECRET` –≤ environment variables
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL webhook –≤ Clerk Dashboard
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ `database/users.json`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ webhook –≤ –∫–æ–Ω—Å–æ–ª–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/api/users` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚ùå –û—à–∏–±–∫–∏ CAPTCHA –∏—Å—á–µ–∑–ª–∏
- ‚ùå –û—à–∏–±–∫–∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ 400 –∏—Å—á–µ–∑–ª–∏  
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ Webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è Clerk
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ 