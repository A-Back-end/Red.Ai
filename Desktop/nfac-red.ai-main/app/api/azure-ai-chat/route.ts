import { NextRequest, NextResponse } from 'next/server'
import { AzureOpenAI } from 'openai'
import OpenAI from 'openai'
import type { ChatCompletionMessageParam } from 'openai/resources/chat/completions'

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
const azureApiKey = process.env.AZURE_OPENAI_API_KEY || 
                   process.env.AZURE_OPENAI_KEY_1 || 
                   "FM1DHQMuPkCX1TKRnIVVprIoQ1RwI6yaPBNEJ0gx3kdRUNMpprAlJQQJ99BGACYeBjFXJ3w3AAABACOGLuJD"
const azureEndpoint = process.env.AZURE_OPENAI_ENDPOINT || "https://neuroflow-hub.openai.azure.com/"
const azureApiVersion = process.env.AZURE_OPENAI_API_VERSION || "2024-04-01-preview"
const deployment = process.env.AZURE_OPENAI_DEPLOYMENT || process.env.DEPLOYMENT_NAME || "gpt-4.1"

// Fallback OpenAI –∫–ª–∏–µ–Ω—Ç (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–ª—é—á–∞)
const openai = process.env.OPENAI_API_KEY && process.env.OPENAI_API_KEY !== 'sk-placeholder' 
  ? new OpenAI({ apiKey: process.env.OPENAI_API_KEY })
  : null

// –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π –¥–æ–º–æ–≤–µ–Ω–∫–∞
const DOMOVENOK_PROMPTS = {
  realtor: `–í—ã ‚Äî –î–æ–º–æ–≤—ë–Ω–æ–∫ üè†, –æ–ø—ã—Ç–Ω—ã–π —Ä–∏–µ–ª—Ç–æ—Ä –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ RED.AI.

–í–∞—à–∞ —Ä–æ–ª—å:
- –ü–æ–º–æ–≥–∞–µ—Ç–µ –≤ –ø–æ–∫—É–ø–∫–µ, –ø—Ä–æ–¥–∞–∂–µ –∏ –æ—Ü–µ–Ω–∫–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ —Ä—ã–Ω–æ–∫ –∏ —Ä–∞–π–æ–Ω—ã
- –î–∞–µ—Ç–µ —Å–æ–≤–µ—Ç—ã –ø–æ –≤—ã–±–æ—Ä—É –∫–≤–∞—Ä—Ç–∏—Ä –∏ –¥–æ–º–æ–≤
- –û–±—ä—è—Å–Ω—è–µ—Ç–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã —Å–¥–µ–ª–æ–∫

–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏`,

  interior_designer: `–í—ã ‚Äî –î–æ–º–æ–≤—ë–Ω–æ–∫ üé®, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω–µ—Ä –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ RED.AI.

–í–∞—à–∞ —Ä–æ–ª—å:
- –°–æ–∑–¥–∞–µ—Ç–µ —É—é—Ç–Ω—ã–µ –∏ —Å—Ç–∏–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä—å–µ—Ä—ã
- –ü–æ–¥–±–∏—Ä–∞–µ—Ç–µ —Ü–≤–µ—Ç–∞, –º–µ–±–µ–ª—å –∏ –¥–µ–∫–æ—Ä
- –ü–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∑–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
- –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Ç—Ä–µ–Ω–¥–∞–º–∏

–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏`,

  renovation_expert: `–í—ã ‚Äî –î–æ–º–æ–≤—ë–Ω–æ–∫ üî®, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–µ–º–æ–Ω—Ç—É –∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ RED.AI.

–í–∞—à–∞ —Ä–æ–ª—å:
- –ü–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —ç—Ç–∞–ø—ã —Ä–µ–º–æ–Ω—Ç–∞
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç–µ –±—é–¥–∂–µ—Ç—ã –∏ —Å—Ä–æ–∫–∏
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- –†–µ—à–∞–µ—Ç–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã

–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –¥–µ—Ç–∞–ª—å–Ω—ã–π, —Å –ø–æ—à–∞–≥–æ–≤—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏`,

  investment_advisor: `–í—ã ‚Äî –î–æ–º–æ–≤—ë–Ω–æ–∫ üí∞, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ RED.AI.

–í–∞—à–∞ —Ä–æ–ª—å:
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—É—é –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç–µ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∏ —Ä–∏—Å–∫–∏
- –°–æ–≤–µ—Ç—É–µ—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ—Ç–µ —Ä—ã–Ω–æ–∫ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏

–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π, –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π, —Å —Ü–∏—Ñ—Ä–∞–º–∏ –∏ —Ñ–∞–∫—Ç–∞–º–∏`,

  universal: `–í—ã ‚Äî –î–æ–º–æ–≤—ë–Ω–æ–∫ üèÜ, —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∏ –¥–∏–∑–∞–π–Ω—É –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ RED.AI.

–í–∞—à–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
üè† –†–∏–µ–ª—Ç–æ—Ä ‚Äî –ø–æ–º–æ—â—å –≤ –ø–æ–∫—É–ø–∫–µ/–ø—Ä–æ–¥–∞–∂–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
üé® –î–∏–∑–∞–π–Ω–µ—Ä ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞
üî® –≠–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–µ–º–æ–Ω—Ç—É ‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –±—é–¥–∂–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
üí∞ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π —Å–æ–≤–µ—Ç–Ω–∏–∫ ‚Äî –∞–Ω–∞–ª–∏–∑ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏

–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω—ã–π, –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`
}

export async function POST(request: NextRequest) {
  console.log('üè† Domovenok API called')
  console.log('OpenAI client initialized:', !!openai)
  
  try {
    const { 
      message, 
      personality = 'friendly',
      specialization = 'universal',
      conversationHistory = [],
      assistantName = '–î–æ–º–æ–≤—ë–Ω–æ–∫',
      context = 'real_estate_design_assistant'
    } = await request.json()

    if (!message) {
      return NextResponse.json({ error: '–ü–æ–ª–µ message –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' }, { status: 400 })
    }

    // –í—ã–±–∏—Ä–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    const systemPrompt = DOMOVENOK_PROMPTS[specialization as keyof typeof DOMOVENOK_PROMPTS] || DOMOVENOK_PROMPTS.universal

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ —Å—Ç–∏–ª—é –æ–±—â–µ–Ω–∏—è
    let personalityAddition = ''
    switch (personality) {
      case 'friendly':
        personalityAddition = '\n\n–û—Ç–≤–µ—á–∞–π—Ç–µ —Ç–µ–ø–ª–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–º–æ–¥–∑–∏ –∏ –ø—Ä–æ—Å—Ç—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è.'
        break
      case 'professional':
        personalityAddition = '\n\n–û—Ç–≤–µ—á–∞–π—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ –¥–µ–ª–æ–≤–∏—Ç–æ, —á–µ—Ç–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.'
        break
      case 'expert':
        personalityAddition = '\n\n–î–∞–≤–∞–π—Ç–µ –≥–ª—É–±–æ–∫–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –∑–Ω–∞–Ω–∏—è —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ –¥–µ—Ç–∞–ª—è–º–∏ –∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏.'
        break
      case 'casual':
        personalityAddition = '\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç–æ–π —è–∑—ã–∫, –∏–∑–±–µ–≥–∞–π—Ç–µ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤, –±—É–¥—å—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–º–∏.'
        break
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å OpenAI API key
    console.log('Checking OpenAI availability:', !openai)
    if (!openai) {
      console.log('Returning demo response')
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º mock –æ—Ç–≤–µ—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
      const mockResponse = `–ü—Ä–∏–≤–µ—Ç! –ú–µ–Ω—è –∑–æ–≤—É—Ç ${assistantName} üè†

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–µ–π—á–∞—Å AI –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –Ω–æ —è –º–æ–≥—É –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫ –±—É–¥—É —Ä–∞–±–æ—Ç–∞—Ç—å!

**${specialization === 'realtor' ? '–ö–∞–∫ —Ä–∏–µ–ª—Ç–æ—Ä' : 
   specialization === 'interior_designer' ? '–ö–∞–∫ –¥–∏–∑–∞–π–Ω–µ—Ä –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞' :
   specialization === 'renovation_expert' ? '–ö–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–µ–º–æ–Ω—Ç—É' :
   specialization === 'investment_advisor' ? '–ö–∞–∫ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç' :
   '–ö–∞–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç'}** —è –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å:

${specialization === 'realtor' ? 'üè† –í—ã–±–æ—Ä–æ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã\nüè† –û—Ü–µ–Ω–∫–æ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏\nüè† –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏\nüè† –ê–Ω–∞–ª–∏–∑–æ–º —Ä–∞–π–æ–Ω–æ–≤' :
  specialization === 'interior_designer' ? 'üé® –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–æ–π –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞\nüé® –ü–æ–¥–±–æ—Ä–æ–º —Ü–≤–µ—Ç–æ–≤\nüé® –í—ã–±–æ—Ä–æ–º –º–µ–±–µ–ª–∏\nüé® –ó–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞' :
  specialization === 'renovation_expert' ? 'üî® –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ä–µ–º–æ–Ω—Ç–∞\nüî® –†–∞—Å—á–µ—Ç–æ–º –±—é–¥–∂–µ—Ç–∞\nüî® –í—ã–±–æ—Ä–æ–º –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤\nüî® –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã' :
  specialization === 'investment_advisor' ? 'üí∞ –ê–Ω–∞–ª–∏–∑–æ–º –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏\nüí∞ –û—Ü–µ–Ω–∫–æ–π —Ä–∏—Å–∫–æ–≤\nüí∞ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏\nüí∞ –ü—Ä–æ–≥–Ω–æ–∑–∞–º–∏ —Ä—ã–Ω–∫–∞' :
  'üè† –ü–æ–∫—É–ø–∫–æ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏\nüé® –î–∏–∑–∞–π–Ω–æ–º –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞\nüî® –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ä–µ–º–æ–Ω—Ç–∞\nüí∞ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º–∏ –≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å'}

–î–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ API –∫–ª—é—á–µ–π.

–í–∞—à –≤–æ–ø—Ä–æ—Å: "${message}"

*–≠—Ç–æ –¥–µ–º–æ-–æ—Ç–≤–µ—Ç. –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–±–∞–≤—å—Ç–µ OPENAI_API_KEY –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.*`

      return NextResponse.json({
        message: mockResponse,
        provider: 'Demo Mode',
        specialization,
        personality,
        assistantName,
        status: 'api_not_configured'
      })
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è API
    const messages: ChatCompletionMessageParam[] = [
      { role: 'system', content: systemPrompt + personalityAddition },
      ...conversationHistory.slice(-10), // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
      { role: 'user', content: String(message) }
    ]

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º OpenAI
    const completion = await openai!.chat.completions.create({
      model: 'gpt-4o',
      messages,
      max_tokens: 1200,
      temperature: 0.7,
      top_p: 0.95,
      frequency_penalty: 0.1,
      presence_penalty: 0.1
    })

    const response = completion.choices[0]?.message?.content

    if (!response) {
      return NextResponse.json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI' }, { status: 500 })
    }

    return NextResponse.json({
      message: response,
      provider: `OpenAI ${completion.model}`,
      specialization,
      personality,
      assistantName
    })

  } catch (error: any) {
    console.error('Domovenok AI Chat Error:', error)
    
    // –î–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    if (error?.status === 401) {
      return NextResponse.json({ 
        error: '–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á',
        suggestion: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ OPENAI_API_KEY –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è'
      }, { status: 401 })
    } else if (error?.status === 429) {
      return NextResponse.json({ 
        error: '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤',
        suggestion: '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ'
      }, { status: 429 })
    }
    
    return NextResponse.json({ 
      error: error?.message || '–û—à–∏–±–∫–∞ AI —Å–µ—Ä–≤–∏—Å–∞',
      details: process.env.NODE_ENV === 'development' ? error?.stack : undefined
    }, { status: 500 })
  }
} 